;;; -*- coding: utf-8; mode:emacs-lisp -*-
;;; set-perl5lib.el --- set path into PERL5LIB if its file path includes 'lib' directory

;; Copyright (C) 2008 Taiyoh Tanaka
;; Author: Taiyoh Tanaka <sun.basix@gmail.com>

;; This file is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published
;; by the Free Software Foundation; either version 2, or (at your
;; option) any later version.

;; This file is distributed in the hope that it will be useful, but
;; WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
;; General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GNU Emacs; see the file COPYING.  If not, write to the
;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
;; Boston, MA 02111-1307, USA.

;;; Commentary:

;;; * set-perl5lib 縺ｫ縺､縺・※

;;; 繝輔ぃ繧､繝ｫ縺ｮ繝代せ縺ｫ"lib"縺ｨ縺・≧繝・ぅ繝ｬ繧ｯ繝医Μ縺悟性縺ｾ繧後※縺・◆繧峨・;;; 縺昴％縺ｾ縺ｧ縺ｮ繝代せ繧単ERL5LIB縺ｫ逋ｻ骭ｲ縺励∪縺吶・;;;
;;; 縺ｾ縺溘・emacs縺ｫ縺ｦ縲・;;; (require 'set-perl5lib)
;;; 縺ｮ縺ゅ→縺ｧ縲：lymake縺ｮflymake-perl-load髢｢謨ｰ繧偵が繝ｼ繝舌・繝ｩ繧､繝峨＠縺ｦ
;;; (set-perl5lib)
;;; 繧帝未謨ｰ蜀・↓霑ｽ蜉縺吶ｌ縺ｰ縲∬・蜍慕噪縺ｫ繝代せ繧堤匳骭ｲ縺ｧ縺阪∪縺吶・;;;
;;; SeeAlso: http://d.hatena.ne.jp/sun-basix/20080117/1200528765

(defun perllib-check-path (lst lib-path)
  (let ((dir (car lst))
        (set-lib-path (concat lib-path "/lib")))
    (if (setf stock-lst (cdr lst))
        (cond ((string= dir "lib") set-lib-path)
              ((and (string= dir "t")
                    (file-readable-p set-lib-path)) set-lib-path)
              (t (perllib-check-path stock-lst (concat lib-path "/" dir)))))))

(defun set-perl5lib ()
  "Set path into PERL5LIB if its file path includes 'lib' directory"
  (interactive)
  (let* ((path-list (cdr (split-string
                          (if (string-match "^.:" buffer-file-name)
                              (concat (cygwin-mount-get-cygdrive-prefix)
                                      (mapconcat 'identity (split-string buffer-file-name ":") ""))
                            (buffer-file-name)
                            )
                          "/")))
         (lib-path (perllib-check-path path-list ""))
         (current-perl5lib (getenv "PERL5LIB")))
    (when (or (and lib-path current-perl5lib
               (not (string-match lib-path current-perl5lib)))
              (not current-perl5lib))
      (setenv "PERL5LIB" (concat lib-path ":" current-perl5lib))
      (message "Added %s into PERL5LIB" lib-path))))

(provide 'set-perl5lib)
